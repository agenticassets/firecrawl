---
description: Patterns and conventions for API development in apps/api, including controllers, routes, and services.
globs: apps/api/src/**/*.ts
alwaysApply: true
---

# API Development (apps/api)

Guidelines for developing and maintaining the Firecrawl API.

## Architecture

The API follows a standard controller-route-service pattern:
- **Routes** (`src/routes/`): Define endpoints and apply middleware (auth, rate limiting).
- **Controllers** (`src/controllers/`): Handle request validation and response formatting. Versions (v0, v1, v2) are strictly separated.
- **Services** (`src/services/`): Contain business logic and interact with external systems (DB, Redis, Queues).
- **Lib** (`src/lib/`): Shared utilities, core logic, and third-party integrations.

## Versioning

Always maintain backward compatibility. New features should ideally be added to the latest version (`v2`) unless they are bug fixes for older versions.
- Path-based versioning: `/v1/scrape`, `/v2/scrape`.
- Directory-based code organization: `src/controllers/v1`, `src/controllers/v2`.

## Error Handling

Use the custom error classes defined in `@/apps/api/src/lib/error.ts`.
- `CustomError`: Base class for API errors.
- Ensure appropriate HTTP status codes are returned (400 for client errors, 401/403 for auth, 500 for server errors).

## Validation

- Use `Zod` for request body and query parameter validation.
- Define schemas in the controller or a shared types file.

## Performance & Resource Management

- **CPU/RAM Monitoring**: Workers should respect `MAX_CPU` and `MAX_RAM` thresholds.
- **Timeouts**: Always use `scrapeTimeout` for scraping operations to prevent hanging requests.

## Database Integration

- Use PostgreSQL for persistent data.
- Use Redis for caching and task orchestration (BullMQ).
